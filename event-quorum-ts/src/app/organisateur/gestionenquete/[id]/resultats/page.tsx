// File: src/app/organisateur/gestionenquetes/[id]/resultats/page.tsx

'use client'

import React, { useState, useEffect } from 'react';
import { useRouter, useParams } from 'next/navigation';
import { Box, Button, Tooltip } from '@mui/material';

// ‚úÖ Import des 5 composants sp√©cialis√©s
import EnqueteResultsHeader from './components/EnqueteResultsHeader';
import Question1ResultCard from './components/Question1ResultCard';
import Question2ResultCard from './components/Question2ResultCard';
import QuestionChartResultCard from './components/QuestionChartResultCard';
import QuestionListResultCard from './components/QuestionListResultCard';
import Loading from 'src/app/loading';

// Import des types
import { Question, Enquete } from '../../nouveau/types';

/**
 * Interface pour les statistiques de l'enqu√™te
 */
interface EnqueteStats {
  totalParticipants: number;
  participantsEnCours: number;
  participantsTermines: number;
  tauxParticipation: number;
}

/**
 * Interface pour les r√©ponses d'une question
 */
interface QuestionResult {
  questionId: number;
  question: string;
  type: Question['type'];
  totalReponses: number;
  reponses: {
    [key: string]: {
      count: number;
      percentage: number;
      label: string;
    }
  };
  // Pour les questions libres
  reponsesLibres?: string[];
  // Pour les √©chelles lin√©aires
  moyenneEchelle?: number;
  repartitionEchelle?: { [key: number]: number };
}

/**
 * Interface pour les d√©tails complets des r√©sultats
 */
interface EnqueteResultsDetail {
  enquete: Enquete;
  stats: EnqueteStats;
  questions: Question[];
  resultats: QuestionResult[];
  createdAt: string;
  statut: 'Termin√©' | 'En cours' | 'Non d√©marr√©';
}

/**
 * Donn√©es d'exemple selon vos maquettes
 */
const sampleResultsData: EnqueteResultsDetail = {
  enquete: {
    id: 1,
    titre: "ENQU√äTE 1",
    activite: "ACTIVIT√â 1",
    typeEnquete: "live",
    enqueteAnonymat: true,
    authentificationNumerique: false,
    createdAt: "2024-01-15"
  },
  stats: {
    totalParticipants: 80,
    participantsEnCours: 23,
    participantsTermines: 50,
    tauxParticipation: 65
  },
  questions: [
    {
      id: 1,
      question: "Les populations de la c√¥te d'ivoire propose que √©tablissement de la carte nationale d'identit√© soit gratuit. Qu'en pensez vous ??",
      type: "choix_multiple",
      reponses: ["Oui", "Non", "Sans avis"],
      enqueteId: 1,
      nombrePoints: 10,
      bonneReponse: 0,
      required: true
    },
    {
      id: 2,
      question: "Quel est le principal avantage de la rotation des cultures ?",
      type: "choix_multiple",
      reponses: ["R√©ponse1", "R√©ponse2", "R√©ponse3", "R√©ponse4"],
      enqueteId: 1,
      nombrePoints: 10,
      bonneReponse: 1,
      required: true
    },
    {
      id: 3,
      question: "Sur une √©chelle de 1 √† 5, √† quel point pensez-vous que cette conf√©rence sera utile pour votre carri√®re ?",
      type: "echelle_lineaire",
      reponses: [],
      enqueteId: 1,
      nombrePoints: 0,
      bonneReponse: 0,
      required: true,
      echelleMin: 1,
      echelleMax: 5
    },
    {
      id: 4,
      question: "Quel intervenant aimeriez-vous voir √† cette conf√©rence ?",
      type: "liste_deroulante",
      reponses: [
        "Bouadou kouadou evarist ( Proposition 1 )",
        "Bouadou kouadou evarist ( Proposition 2 )",
        "Bouadou kouadou evarist ( Proposition 3 )",
        "Bouadou kouadou evarist ( Proposition 4 )"
      ],
      enqueteId: 1,
      nombrePoints: 15,
      bonneReponse: 0,
      required: false
    }
  ],
  resultats: [
    {
      questionId: 1,
      question: "Les populations de la c√¥te d'ivoire propose que √©tablissement de la carte nationale d'identit√© soit gratuit. Qu'en pensez vous ??",
      type: "choix_multiple",
      totalReponses: 50,
      reponses: {
        "0": { count: 35, percentage: 70, label: "Oui" },
        "1": { count: 13, percentage: 25, label: "Non" },
        "2": { count: 2, percentage: 5, label: "Sans avis" }
      }
    },
    {
      questionId: 2,
      question: "Quel est le principal avantage de la rotation des cultures ?",
      type: "choix_multiple",
      totalReponses: 60,
      reponses: {
        "0": { count: 3, percentage: 5, label: "R√©ponse1" },
        "1": { count: 55, percentage: 92, label: "R√©ponse2" },
        "2": { count: 2, percentage: 3, label: "R√©ponse3" },
        "3": { count: 0, percentage: 0, label: "R√©ponse4" }
      }
    },
    {
      questionId: 3,
      question: "Sur une √©chelle de 1 √† 5, √† quel point pensez-vous que cette conf√©rence sera utile pour votre carri√®re ?",
      type: "echelle_lineaire",
      totalReponses: 30,
      reponses: {},
      moyenneEchelle: 3.8,
      repartitionEchelle: {
        1: 2, 2: 3, 3: 1, 4: 30, 5: 15
      }
    },
    {
      questionId: 4,
      question: "Quel intervenant aimeriez-vous voir √† cette conf√©rence ?",
      type: "liste_deroulante",
      totalReponses: 4,
      reponses: {
        "0": { count: 0, percentage: 0, label: "Bouadou kouadou evarist ( Proposition 1 )" },
        "1": { count: 0, percentage: 0, label: "Bouadou kouadou evarist ( Proposition 2 )" },
        "2": { count: 0, percentage: 0, label: "Bouadou kouadou evarist ( Proposition 3 )" },
        "3": { count: 0, percentage: 0, label: "Bouadou kouadou evarist ( Proposition 4 )" }
      }
    }
  ],
  createdAt: "2024-01-15",
  statut: "En cours"
};

/**
 * üéØ PAGE PRINCIPALE - Assemblage de tous les composants
 */
const EnqueteResultsPage: React.FC = () => {
  const router = useRouter();
  const params = useParams();
  const enqueteId = params.id as string;

  // √âtats principaux
  const [resultsData, setResultsData] = useState<EnqueteResultsDetail | null>(null);
  const [loading, setLoading] = useState(true);

  /**
   * Chargement des donn√©es de r√©sultats au montage du composant
   */
  useEffect(() => {
    const loadResultsData = async () => {
      try {
        setLoading(true);
        
        // TODO: Remplacer par votre appel API r√©el
        // const response = await fetch(`/api/enquetes/${enqueteId}/resultats`);
        // const data = await response.json();
        // setResultsData(data);

        // Simulation d'un d√©lai de chargement
        await new Promise(resolve => setTimeout(resolve, 1000));
        setResultsData(sampleResultsData);
        
      } catch (error) {
        console.error('Erreur lors du chargement des r√©sultats:', error);
      } finally {
        setLoading(false);
      }
    };

    if (enqueteId) {
      loadResultsData();
    }
  }, [enqueteId]);

  /**
   * üîÑ GESTIONNAIRES D'√âV√âNEMENTS
   */
  const handleBack = () => {
    router.push(`/organisateur/gestionenquete/${enqueteId}`);
  };

  const handleExport = () => {
    console.log('Export des r√©sultats pour l\'enqu√™te:', enqueteId);
    alert('Fonctionnalit√© d\'export en cours de d√©veloppement');
  };
  const handleViewDetail = (questionId: number) => {
    console.log('Voir d√©tail de la question:', questionId);
    // L'alert peut √™tre supprim√© car le modal s'affiche maintenant
  };

  /**
   * üÜï Gestionnaire pour voir les r√©sultats des participants
   */
  const handleViewParticipantsResults = () => {
    console.log('Voir les r√©sultats des participants pour l\'enqu√™te:', enqueteId);
    // Navigation vers la page des r√©sultats des participants
    router.push(`/organisateur/gestionenquete/${enqueteId}/resultats/participants`);
  };

  /**
   * üîÑ FONCTIONS DE CONVERSION pour Question 3 et 4
   */
  const convertToChartReponses = (result: QuestionResult) => {
    if (result.repartitionEchelle) {
      return Object.entries(result.repartitionEchelle).map(([scale, count]) => ({
        label: `Note ${scale}`,
        count: count,
        percentage: Math.round((count / result.totalReponses) * 100)
      }));
    }
    return [];
  };

  const convertToListReponses = (result: QuestionResult) => {
    return Object.values(result.reponses).map(reponse => ({
      label: reponse.label,
      count: reponse.count,
      selected: reponse.count > 0
    }));
  };

  /**
   * üéØ RENDU CONDITIONNEL - Le c≈ìur de l'assemblage
   */
  const renderQuestionResult = (result: QuestionResult) => {
    // ‚úÖ Question 1 : Composant sp√©cialis√© avec vraies donn√©es
    if (result.questionId === 1) {
      return (
        <Question1ResultCard
          key={result.questionId}
          onViewDetail={() => handleViewDetail(result.questionId)}
          // Passer les vraies donn√©es de la page
          questionData={{
            questionNumber: result.questionId,
            question: result.question,
            totalParticipants: resultsData?.stats.totalParticipants || 80,
            totalReponses: result.totalReponses,
            reponses: Object.values(result.reponses).map((reponse, index) => ({
              label: reponse.label,
              count: reponse.count,
              percentage: reponse.percentage,
              color: ['#1976d2', '#42a5f5', '#64b5f6'][index] || '#90caf9'
            }))
          }}
        />
      );
    }

    // ‚úÖ Question 2 : Composant sp√©cialis√© avec vraies donn√©es
    if (result.questionId === 2) {
      return (
        <Question2ResultCard
          key={result.questionId}
          onViewDetail={() => handleViewDetail(result.questionId)}
          // Passer les vraies donn√©es de la page
          questionData={{
            questionNumber: result.questionId,
            question: result.question,
            totalParticipants: resultsData?.stats.totalParticipants || 80,
            totalReponses: result.totalReponses,
            reponses: Object.values(result.reponses).map((reponse, index) => ({
              label: reponse.label,
              count: reponse.count,
              percentage: reponse.percentage,
              color: ['#1976d2', '#42a5f5', '#64b5f6', '#90caf9'][index] || '#bbdefb'
            }))
          }}
        />
      );
    }

    // ‚úÖ Question 3 : Composant avec graphique
    if (result.questionId === 3 && result.type === 'echelle_lineaire') {
      return (
        <QuestionChartResultCard
          key={result.questionId}
          questionNumber={result.questionId}
          question={result.question}
          totalParticipants={resultsData?.stats.totalParticipants || 0}
          totalReponses={result.totalReponses}
          reponses={convertToChartReponses(result)}
          onViewDetail={() => handleViewDetail(result.questionId)}
        />
      );
    }

    // ‚úÖ Question 4 : Composant avec liste
    if (result.questionId === 4) {
      return (
        <QuestionListResultCard
          key={result.questionId}
          questionNumber={result.questionId}
          question={result.question}
          totalParticipants={resultsData?.stats.totalParticipants || 0}
          totalReponses={result.totalReponses}
          reponses={convertToListReponses(result)}
          onViewDetail={() => handleViewDetail(result.questionId)}
        />
      );
    }

    return null;
  };

  // ===========================================
  // üîÑ RENDU CONDITIONNEL - CHARGEMENT
  // ===========================================
  if (loading) {
    return <Loading />;
  }

  // ===========================================
  // üîÑ RENDU CONDITIONNEL - ERREUR
  // ===========================================
  if (!resultsData) {
    return (
      <Box sx={{ 
        display: 'flex', 
        justifyContent: 'center', 
        alignItems: 'center', 
        height: '100vh',
        backgroundColor: '#fafafa'
      }}>
        <Box sx={{ 
          textAlign: 'center',
          p: 4,
          bgcolor: '#fff',
          borderRadius: '12px',
          boxShadow: '0 4px 20px rgba(0,0,0,0.08)'
        }}>
          <h2 style={{ color: '#333', marginBottom: '1rem' }}>R√©sultats introuvables</h2>
          <p style={{ color: '#666' }}>Impossible de charger les r√©sultats de cette enqu√™te.</p>
        </Box>
      </Box>
    );
  }

  // ===========================================
  // üéØ RENDU PRINCIPAL - ASSEMBLAGE FINAL
  // ===========================================
  return (
    <Box sx={{ 
      p: { xs: 2, sm: 3, md: 4 },
      backgroundColor: '#fafafa', 
      minHeight: '100vh' 
    }}>
      {/* üîù EN-T√äTE avec widgets oranges */}
      <EnqueteResultsHeader
        enqueteTitre={resultsData.enquete.titre}
        activiteTitre={resultsData.enquete.activite}
        nombreParticipants={resultsData.stats.totalParticipants}
        nombreQuestions={resultsData.questions.length}
        tauxParticipation={resultsData.stats.tauxParticipation}
        onExport={handleExport}
        onBack={handleBack}
      />

      {/* üÜï BOUTON "Voir les r√©sultats des participants" avec Tooltip - Align√© √† droite */}
      <Box sx={{ 
        display: 'flex', 
        justifyContent: 'flex-end', 
        mt: 2, 
        mb: 2 
      }}>
        <Tooltip title="Voir les r√©sultats des participants" arrow>
          <Button
            variant="contained"
            onClick={handleViewParticipantsResults}
            sx={{
              bgcolor: '#1976d2',
              color: 'white',
              textTransform: 'none',
              fontWeight: 600,
              fontSize: '0.875rem',
              px: 3,
              py: 1.2,
              borderRadius: '8px',
              boxShadow: '0 2px 8px rgba(25, 118, 210, 0.2)',
              '&:hover': {
                bgcolor: '#1565c0',
                boxShadow: '0 4px 12px rgba(25, 118, 210, 0.3)',
                transform: 'translateY(-1px)'
              },
              transition: 'all 0.2s ease-in-out'
            }}
          >
            Voir les r√©sultats
          </Button>
        </Tooltip>
      </Box>

      {/* üìä R√âSULTATS par question avec composants sp√©cialis√©s */}
      <Box sx={{ mt: 2 }}>
        {resultsData.resultats.map(result => renderQuestionResult(result))}
      </Box>
    </Box>
  );
};

export default EnqueteResultsPage;